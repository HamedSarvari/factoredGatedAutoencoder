import numpy as np
import random
import pickle
from universal_utils import *

########################################################################################################################
# generates as many as size, 'dim' dimensional guassian points with mean mu and sd sigma.
# Returns a matrix with generated points
def gauss_nd(mu, sigma, dim, size):
    all_points=[]
    for i in range(size):
        point=[]
        for j in range(dim):
            point.append(list(np.random.normal(mu, sigma, 1))[0])
        all_points.append(point)
    return np.array(all_points)

########################################################################################################################

# Takes a dataset generated by gauss_nd and a threshold and returns labels of inliers/outliers
def check_outlierness(dataset, mu, threshold):

    dim = dataset.shape[1]

    # Find points that are more than threshold away from the mean in 70 percent of the features
    outliers = np.array([sum(np.array(np.abs(dataset[ind, :] - mu)) > threshold) > int(0.7*dim) for ind in range(dataset.shape[0])])
    labels = outliers + 0

    return labels
########################################################################################################################

# Generates two gaussian with means mu1 and mu2 and returns data/ labels/ class labels
def Gen_2_gaussians(mu1, mu2, sigma, dim, size):

    dataset1 = gauss_nd(mu1, sigma, dim, size)
    dataset2 = gauss_nd(mu2, sigma, dim, size)

    # Threshold is set to 1 sigma.
    ds1_labels = check_outlierness(dataset1, mu1, 1 * sigma)
    ds2_labels = check_outlierness(dataset2, mu2, 1 * sigma)

    dataset = np.concatenate((dataset1, dataset2))
    labels = np.concatenate((ds1_labels, ds2_labels))
    class_labels = [1] * len(ds1_labels) + [2] * len(ds2_labels)

    return dataset, labels, class_labels

########################################################################################################################

def generate_pairs_two_gauss(data_name, GT_prcnt):

    loaded_data = load_obj(data_name)
    data = loaded_data['data']
    labels = loaded_data ['labels']
    class_labels = loaded_data ['class_labels']

    IDs = np.array(range(data.shape[0]))
    outlier_inds = IDs[labels == 1]
    inlier_inds = IDs[labels == 0]

    # outlier_inds = labelslabels == 1
    print('number of outliers=', len(outlier_inds))

    random_outlier_inds = random.sample(list(outlier_inds), int(np.ceil(GT_prcnt * len(outlier_inds))))

    print('number of selected=', len(random_outlier_inds))
    print('selected outliers', random_outlier_inds, len(random_outlier_inds))
    random_inlier_inds = random.sample(list(inlier_inds), int(GT_prcnt * len(inlier_inds)))
    print('selected inliers', len(random_inlier_inds))

    unlabeled_outlier_inds = [i for i in outlier_inds if i not in random_outlier_inds]
    unlabeled_inlier_inds = [i for i in inlier_inds if i not in random_inlier_inds]

    ######################### Save the information about labels  ################################
    labels_info = {}
    labels_info['random_outlier_inds'] = random_outlier_inds
    labels_info['random_inlier_inds'] = random_inlier_inds
    labels_info['unlabeled_outlier_inds'] = unlabeled_outlier_inds
    labels_info['unlabeled_inlier_inds'] = unlabeled_inlier_inds
    save_obj(labels_info, data_name + '_labels')
    #############################################################################################

    outlier_inlier_pairs = [(a, b) for a in random_outlier_inds for b in random_inlier_inds if a != b] + \
                           [(a, b) for b in random_outlier_inds for a in random_inlier_inds if a != b]

    inlier_inlier_pairs = [(a, b) for a in random_inlier_inds for b in random_inlier_inds if a != b and
                           class_labels[a] == class_labels[b]]


    print(len(inlier_inlier_pairs),'in-in')
    print(len(outlier_inlier_pairs), 'out-in')

    List_X = []
    List_Y = []
    List_labels = []

    for element in inlier_inlier_pairs :
        List_X.append(data[element[0],:])
        List_Y.append(data[element[1],:])
        List_labels.append(1)

    for element in outlier_inlier_pairs:
        List_X.append(data[element[0], :])
        List_Y.append(data[element[1], :])
        List_labels.append(0)


    X = np.array(List_X)
    Y = np.array(List_Y)

    L = np.matrix(List_labels)
    L = L.transpose()

    return X,Y,L, unlabeled_inlier_inds, unlabeled_outlier_inds

########################################################################################################################
#
# mu1 = 0
# mu2 = 5
# sigma = 1
# dim = 7
# size = 2500
# GT_prcnt = 0.1
#
# data, labels, class_labels = Gen_2_gaussians(mu1, mu2, sigma, dim, size)
# data_dic = {}
# data_dic['data'] = data
# data_dic['labels'] = labels
# data_dic['class_labels'] = class_labels
#
#save_obj(data_dic,'TwoGauss_data_7dim')

#loaded_data = load_obj('TwoGauss_data_7dim')

#print(loaded_data['class_labels'][1:200])
